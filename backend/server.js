// D:\meuscursos\backend\server.js

import dotenv from 'dotenv';
dotenv.config(); // Carrega as vari√°veis de ambiente do .env

import express from 'express';
import cors from 'cors';

// Importa os middlewares de autentica√ß√£o
import { protect, adminProtect } from './middleware/authMiddleware.js';

// Importa as rotas de autentica√ß√£o
import authRoutes from './routes/authRoutes.js';

// Importa as novas rotas de modelos de IA
import aiModelRoutes from './routes/aiModelRoutes.js'; 

const app = express();
const PORT = process.env.PORT || 3001; 

// --- Configura√ß√£o CORS para Produ√ß√£o ---
const allowedOrigins = [
    process.env.FRONTEND_URL, 
    'http://localhost:3000', 
    'https://meuscursos.netlify.app', 
    'https://meuscursos.onrender.com', 
].filter(Boolean); // Filtra quaisquer valores nulos/indefinidos

app.use(cors({
    origin: function (origin, callback) {
        // Permite requisi√ß√µes sem origem (como de ferramentas Postman/Insomnia ou requisi√ß√µes do mesmo servidor)
        if (!origin) return callback(null, true);
        if (allowedOrigins.indexOf(origin) === -1) {
            const msg = `The CORS policy for this site does not allow access from the specified Origin: ${origin}`;
            console.error(msg); 
            return callback(new Error(msg), false);
        }
        return callback(null, true);
    },
    methods: 'GET,HEAD,PUT,PATCH,POST,DELETE',
    credentials: true, // Permite o envio de cookies de credenciais
    optionsSuccessStatus: 204, // Resposta para requisi√ß√µes OPTIONS bem-sucedidas
}));

app.use(express.json()); // Habilita o parsing de JSON para o corpo das requisi√ß√µes

// --- Rotas da API ---
app.get('/', (req, res) => {
    res.send('Servidor do backend "Meus Cursos" est√° rodando! üôå');
});

// Monta as rotas de Autentica√ß√£o sob o prefixo /api/auth
app.use('/api/auth', authRoutes);

// Monta as novas rotas de modelos de IA sob o prefixo /api/ai-models
// O middleware 'protect' j√° est√° aplicado dentro de 'aiModelRoutes.js' para a rota espec√≠fica.
app.use('/api/ai-models', aiModelRoutes); 

// Exemplo de rota protegida (requer token JWT v√°lido)
// Voc√™ pode adicionar mais rotas protegidas aqui, usando 'protect'
app.get('/api/protected', protect, (req, res) => {
    // req.user estar√° dispon√≠vel aqui com as informa√ß√µes do usu√°rio decodificadas do token
    res.status(200).json({ 
        message: 'Voc√™ acessou uma rota protegida!', 
        user: req.user 
    });
});

// Exemplo de rota protegida para administradores (requer token JWT v√°lido e isAdmin: true)
app.get('/api/admin', protect, adminProtect, (req, res) => {
    res.status(200).json({ 
        message: 'Voc√™ acessou uma rota de administrador!', 
        user: req.user 
    });
});


// Tratamento de erros para JWT (se o token for inv√°lido, etc.)
// Este middleware de erro deve ser o √∫ltimo a ser definido, antes do app.listen
app.use((err, req, res, next) => {
    if (err.name === 'UnauthorizedError') {
        // Erro espec√≠fico do express-jwt (se estivesse sendo usado)
        // Como estamos usando um middleware JWT customizado, este bloco pode ser ajustado
        // O erro j√° √© tratado dentro do middleware 'protect'
        return res.status(401).json({ message: 'N√£o autorizado, token inv√°lido ou expirado.' });
    }
    // Para outros tipos de erros, passa para o pr√≥ximo middleware de erro ou Express lida
    next(err);
});

// --- Inicia o Servidor ---
app.listen(PORT, () => {
    console.log(`üöÄ Servidor do backend rodando em http://localhost:${PORT}`);
    console.log('Aguardando requisi√ß√µes do frontend...');
    console.log('Endpoints dispon√≠veis:');
    console.log(`GET /`);
    console.log(`POST /api/auth/register`); 
    console.log(`POST /api/auth/login`);
    console.log(`GET /api/ai-models (requer autentica√ß√£o)`); // Adicionado o novo endpoint
    console.log(`GET /api/protected (requer autentica√ß√£o)`);
    console.log(`GET /api/admin (requer autentica√ß√£o e permiss√£o de admin)`);
});
