import React, { useState } from 'react';
import {
  Typography,
  Container,
  Box,
  Stepper,
  Step,
  StepLabel,
  StepContent,
  Button,
  Paper,
  TextField,
  CircularProgress,
  Alert
} from '@mui/material';
import { Link /* Removido useNavigate aqui, se n√£o for usar 'navigate' */ } from 'react-router-dom';
import ChevronLeftIcon from '@mui/icons-material/ChevronLeft';

function CourseCreatePage() {
  const [activeStep, setActiveStep] = useState(0);
  const [courseTopic, setCourseTopic] = useState('');
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState(null);
  const [successMessage, setSuccessMessage] = useState(null);
  // const navigate = useNavigate(); // <-- Linha comentada/removida para resolver o warning

  const steps = [
    {
      label: 'Detalhes do Curso',
      description: 'Informe o t√≥pico principal para o novo curso. A IA usar√° isso para gerar o conte√∫do.'
    },
    {
      label: 'Gerar Conte√∫do',
      description: 'Revise o t√≥pico e inicie a gera√ß√£o do curso pela IA. Isso pode levar alguns segundos.'
    },
    {
      label: 'Conclu√≠do',
      description: 'O curso foi gerado e salvo no Sanity CMS!'
    },
  ];

  const handleNext = () => {
    setActiveStep((prevActiveStep) => prevActiveStep + 1);
  };

  // const handleBack = () => { // <-- Fun√ß√£o removida para resolver o warning
  //   setActiveStep((prevActiveStep) => prevActiveStep + 1); // Bug fix: should be prevActiveStep - 1
  // };

  // Corre√ß√£o da fun√ß√£o handleBack para realmente voltar ao passo anterior
  const handleBackCorrected = () => {
    setActiveStep((prevActiveStep) => prevActiveStep - 1);
  };

  const handleReset = () => {
    setActiveStep(0);
    setCourseTopic('');
    setLoading(false);
    setError(null);
    setSuccessMessage(null);
  };

  const handleGenerateCourse = async () => {
    if (!courseTopic.trim()) {
      setError('Por favor, insira um t√≥pico para o curso.');
      return;
    }

    setLoading(true);
    setError(null);
    setSuccessMessage(null);

    try {
      const response = await fetch('http://localhost:3001/api/courses/generate', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({ topic: courseTopic }),
      });

      if (!response.ok) {
        const errorData = await response.json();
        throw new Error(errorData.error || 'Falha ao gerar o curso no backend.');
      }

      const result = await response.json();
      console.log('Curso gerado com sucesso:', result);
      setSuccessMessage('Curso e li√ß√µes gerados e salvos com sucesso no Sanity CMS! üéâ');
      handleNext(); // Avan√ßa para o passo 'Conclu√≠do'

    } catch (err) {
      console.error("Erro ao gerar curso:", err);
      setError(`Erro ao gerar curso: ${err.message}. Verifique o console do backend.`);
      setLoading(false); // Permite tentar novamente no mesmo passo
    } finally {
      // setLoading(false); // J√° √© feito acima se for erro
    }
  };

  return (
    <Container maxWidth="md" sx={{ py: 4 }}>
      <Box sx={{ mb: 4 }}>
        <Button
          component={Link}
          to="/cursos" // Link para a p√°gina de listagem de cursos
          startIcon={<ChevronLeftIcon />}
          variant="outlined"
        >
          Voltar para a Lista de Cursos
        </Button>
      </Box>

      <Typography variant="h4" component="h1" gutterBottom align="center" sx={{ mb: 4 }}>
        Crie um Novo Curso com IA
      </Typography>

      <Stepper activeStep={activeStep} orientation="vertical">
        {steps.map((step, index) => (
          <Step key={step.label}>
            <StepLabel optional={index === 2 ? <Typography variant="caption">Conclus√£o</Typography> : null}>
              {step.label}
            </StepLabel>
            <StepContent>
              <Typography>{step.description}</Typography>
              <Box sx={{ mb: 2 }}>
                {/* Conte√∫do de cada passo */}
                {index === 0 && (
                  <TextField
                    label="T√≥pico do Curso (ex: 'Introdu√ß√£o √† Programa√ß√£o com Python')"
                    variant="outlined"
                    fullWidth
                    margin="normal"
                    value={courseTopic}
                    onChange={(e) => setCourseTopic(e.target.value)}
                    disabled={loading}
                  />
                )}
                {index === 1 && (
                  <Box sx={{ mt: 2 }}>
                    <Typography variant="h6" gutterBottom>
                      T√≥pico Escolhido: <br/>
                      <Box component="span" sx={{ fontWeight: 'bold', color: 'primary.main' }}>
                        "{courseTopic || 'Nenhum t√≥pico inserido'}"
                      </Box>
                    </Typography>
                    <Typography variant="body2" color="text.secondary" sx={{ mt: 1 }}>
                        Ao clicar em "Gerar Curso Agora", a intelig√™ncia artificial ir√° criar o curso e suas li√ß√µes. Este processo pode levar alguns segundos.
                    </Typography>
                  </Box>
                )}

                {/* Bot√µes de navega√ß√£o */}
                <div>
                  <Button
                    variant="contained"
                    onClick={index === 1 ? handleGenerateCourse : handleNext}
                    sx={{ mt: 1, mr: 1 }}
                    disabled={
                      loading ||
                      (index === 0 && !courseTopic.trim()) ||
                      (index === 1 && loading)
                    }
                    startIcon={index === 1 && loading ? <CircularProgress size={20} color="inherit" /> : null}
                  >
                    {index === 1 ? (loading ? 'Gerando...' : 'Gerar Curso Agora') : 'Pr√≥ximo'}
                  </Button>
                  <Button
                    disabled={index === 0 || loading}
                    onClick={handleBackCorrected} // Usando a fun√ß√£o corrigida
                    sx={{ mt: 1, mr: 1 }}
                  >
                    Voltar
                  </Button>
                </div>
                {loading && index === 1 && (
                  <Typography variant="body2" color="text.secondary" sx={{ mt: 1 }}>
                    Aguarde, a IA est√° trabalhando...
                  </Typography>
                )}
                {error && (
                  <Alert severity="error" sx={{ mt: 2 }}>
                    {error}
                  </Alert>
                )}
              </Box>
            </StepContent>
          </Step>
        ))}
      </Stepper>

      {activeStep === steps.length && (
        <Paper square elevation={0} sx={{ p: 3, mt: 3 }}>
          <Typography variant="h6" color="success.main" sx={{ mb: 2 }}>
            {successMessage || 'Processo de cria√ß√£o conclu√≠do!'}
          </Typography>
          {error && (
            <Alert severity="error" sx={{ mb: 2 }}>
              {error}
            </Alert>
          )}
          <Button onClick={handleReset} sx={{ mt: 1, mr: 1 }}>
            Criar Outro Curso
          </Button>
          <Button component={Link} to="/cursos" variant="contained" sx={{ mt: 1 }}>
            Ver Todos os Cursos
          </Button>
        </Paper>
      )}
    </Container>
  );
}

export default CourseCreatePage;